<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ultrarare Calculator</title>
    <link rel="shortcut icon" type="image/x-icon" href="gobattle_ring.ico">

    <style>
      @font-face {
        font-family: Compass;
        src: url("../../UltraCalculator/compass.ttf") format("truetype");
        font-weight: bold;
        font-style: normal;
      }

      :root {
        --panel-bg: rgba(115, 147, 179, 0.92);
        --accent: #7393B3;
        --text: #111;
        --btn-color: #8A2BE2;
      }

      html, body { height: 100%; }

      body {
        font-family: Compass, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        margin: 0;
        padding: 0;
        background-image: url("../../UltraCalculator/gb_stars.png");
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        color: var(--text);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      header {
        color: white;
        padding: 1rem;
        text-align: center;
      }

      main {
        flex: 1 0 auto;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 1rem;
      }

      .panel {
        background: var(--panel-bg);
        padding: 1.5rem;
        border-radius: 12px;
        max-width: 480px;
        width: 100%;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        color: #fff;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 14px;
      }

      label {
        display:block;
        margin-bottom: 6px;
        font-weight:600;
      }

      select, input[type="number"], button {
        font-family: Compass, inherit;
        padding: 0.5rem 0.75rem;
        font-size: 16px;
        border-radius: 8px;
        border: none;
        outline: none;
      }

      select, input[type="number"] { width: 100%; }

      button#generateBtn {
        background: var(--btn-color);
        color: white;
        cursor: pointer;
        font-weight:700;
        transition: background 0.2s;
        width: 100%;
        margin-top: 6px;
      }
      button#generateBtn:hover {
        background: #6A1BB2;
      }
      button#generateBtn:active { transform: translateY(1px); }

      #response {
        margin-top: 12px;
        background: rgba(255,255,255,0.06);
        padding: 12px;
        border-radius: 8px;
        color: white;
        font-size: 16px;
        line-height: 1.4;
        min-height: 40px;
      }

      footer {
        background-color: var(--accent);
        color: white;
        text-align: center;
        padding: 0.75rem;
        font-size: 14px;
        margin-top: auto;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Ultra Drop Calculator</h1>
    </header>

    <main>
      <section class="panel">

        <div class="form-group">
          <label for="dungeonSelect">Dungeon</label>
          <select id="dungeonSelect"><option>Loading…</option></select>
        </div>

        <div class="form-group">
          <label for="ultraSelect">Ultra</label>
          <select id="ultraSelect"><option>Loading…</option></select>
        </div>

        <div class="form-group">
          <label for="luckInput">Luck (LCK) — 0 to 25</label>
          <input id="luckInput" type="number" min="0" max="25" value="0" />
        </div>

        <button id="generateBtn" type="button">Generate Ultra Data</button>

        <div id="response" aria-live="polite"></div>
      </section>
    </main>

    <footer>
      ℹ Licensed under CC0-1.0. Source: 
      <a href="https://github.com/Aratox-Official/UltraCalculator" style="color:inherit;text-decoration:underline">GitHub</a>
    </footer>

    <script>
      function slugify(str = "") {
        return String(str)
          .toLowerCase()
          .trim()
          .replace(/\s+/g, "_")
          .replace(/[^a-z0-9_]/g, "");
      }

      function formatAverageRuns(v) {
        if (!isFinite(v)) return "Impossible (drop chance = 0)";
        if (v < 1000) return `${v.toFixed(2)} runs (average)`;
        return `${Math.round(v).toLocaleString()} runs (average)`;
      }

      let ultraData = [];
      let dungeonData = [];

      const dungeonSelect = document.getElementById("dungeonSelect");
      const ultraSelect = document.getElementById("ultraSelect");
      const luckInput = document.getElementById("luckInput");
      const generateBtn = document.getElementById("generateBtn");
      const responseEl = document.getElementById("response");

      async function loadAllData() {
        try {
          const [uRes, dRes] = await Promise.all([
            fetch("ultra_names.json"),
            fetch("dungeon_tickets.json")
          ]);

          if (!uRes.ok) throw new Error("Failed to load ultra_names.json");
          if (!dRes.ok) throw new Error("Failed to load dungeon_tickets.json");

          ultraData = await uRes.json();
          dungeonData = await dRes.json();

          populateDungeonSelect();
          populateUltraSelect();
        } catch (err) {
          dungeonSelect.innerHTML = '<option>Error loading data</option>';
          ultraSelect.innerHTML = '<option>Error loading data</option>';
          responseEl.textContent = "Error loading JSON files: " + err.message;
          console.error(err);
        }
      }

      function populateDungeonSelect() {
        dungeonData.sort((a, b) => {
          const aName = (a.name || a.id || "").toString();
          const bName = (b.name || b.id || "").toString();
          return aName.localeCompare(bName);
        });

        dungeonSelect.innerHTML = '<option value="">-- Select a dungeon --</option>';
        dungeonData.forEach(d => {
          const display = (d.name || d.id || "").toString().replace(/_/g, " ");
          const option = document.createElement("option");
          option.value = d.name || d.id || display;
          option.textContent = display;
          dungeonSelect.appendChild(option);
        });
      }

      function populateUltraSelect() {
        ultraData.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
        ultraSelect.innerHTML = '<option value="">-- Select an ultra --</option>';
        ultraData.forEach(u => {
          const option = document.createElement("option");
          option.textContent = u.name || ("#" + u.id);
          option.value = (typeof u.id !== "undefined") ? String(u.id) : u.name;
          ultraSelect.appendChild(option);
        });
      }

      generateBtn.addEventListener("click", () => {
        responseEl.innerHTML = "";

        if (!ultraData.length || !dungeonData.length) {
          responseEl.textContent = "Data not loaded yet. Please wait a moment and try again.";
          return;
        }

        const dungeonValue = dungeonSelect.value;
        const ultraValue = ultraSelect.value;
        let luck = parseInt(luckInput.value, 10);
        if (Number.isNaN(luck)) luck = 0;
        luck = Math.max(0, Math.min(25, luck));
        luckInput.value = String(luck);

        if (!dungeonValue || !ultraValue) {
          responseEl.innerHTML = "<strong>Please select both a dungeon and an ultra, then click Generate.</strong>";
          return;
        }

        const dungeon = dungeonData.find(d => {
          if (!d) return false;
          const dName = (d.name || "").toString();
          const dId   = (typeof d.id !== "undefined") ? String(d.id) : "";
          return dName === dungeonValue || dId === dungeonValue;
        });

        const ultra = ultraData.find(u => {
          if (!u) return false;
          if (typeof u.id !== "undefined") return String(u.id) === ultraValue;
          return u.name === ultraValue;
        });

        if (!dungeon) {
          responseEl.innerHTML = `<strong>Selected dungeon not found in dungeon data.</strong>`;
          return;
        }
        if (!ultra) {
          responseEl.innerHTML = `<strong>Selected ultra not found in ultra_names.json.</strong>`;
          return;
        }

        const ultraTickets = Number(ultra.tickets);
        const dungeonTickets = Number(dungeon.tickets);

        if (!isFinite(ultraTickets) || !isFinite(dungeonTickets) || dungeonTickets <= 0) {
          responseEl.innerHTML = `<strong>Tickets data missing or invalid for dungeon/ultra.</strong>`;
          return;
        }

        const dropChance = (100 * ultraTickets / dungeonTickets) * ((0.0005 * luck) + 0.006);

        const avgRuns = (dropChance > 0) ? (100 / dropChance) : Infinity;
        const avgRunsText = formatAverageRuns(avgRuns);

        const ultraDropsIn = (ultra.drops_in || "").toString();
        const dungeonSlug = slugify(dungeon.name || dungeon.id || "");
        const dropsMatch = (
          ultraDropsIn === "" ||
          ultraDropsIn === dungeonSlug ||
          ultraDropsIn === String(dungeon.id) ||
          slugify(ultraDropsIn) === dungeonSlug
        );

        const prettyDungeonName = (dungeon.name || dungeon.id || "").toString().replace(/_/g, " ");
        const prettyDropsIn = (ultra.drops_in || "").toString().replace(/_/g, " ");

        let html = `<strong>${ultra.name}</strong><br>`;
        html += `Dungeon: <strong>${prettyDungeonName}</strong><br><br>`;
        html += `Luck (LCK): <strong>${luck}</strong><br>`;
        html += `<div style="margin-top:8px;font-size:1.15em">Average runs required: <strong>${avgRunsText}</strong></div>`;

        if (!dropsMatch) {
          html += `<div style="margin-top:10px;color:#ffeb99">Note: this ultra normally drops in <strong>${prettyDropsIn || "another dungeon"}</strong>. You selected <strong>${prettyDungeonName}</strong>. Calculation used the selected dungeon's ticket total.</div>`;
        }

        responseEl.innerHTML = html;
      });

      loadAllData();
    </script>
  </body>
</html>
