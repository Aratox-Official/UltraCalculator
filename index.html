<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ultrarare Calculator</title>
    <link rel="shortcut icon" type="image/x-icon" href="gobattle_ring.ico">

    <style>
      @font-face {
        font-family: Compass;
        src: url("../../UltraCalculator/compass.ttf") format("truetype");
        font-weight: bold;
        font-style: normal;
      }

      :root {
        --panel-bg: rgba(115, 147, 179, 0.92);
        --accent: #7393B3;
        --text: #111;
      }

      html, body {
        height: 100%;
      }

      body {
        font-family: Compass, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        margin: 0;
        padding: 0;
        background-image: url("../../UltraCalculator/gb_stars.png");
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        color: var(--text);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      header {
        color: white;
        padding: 1rem;
        text-align: center;
      }

      main {
        flex: 1 0 auto;
        display:flex;
        align-items:center;
        justify-content:center;
        padding: 2rem;
      }

      .panel {
        background: var(--panel-bg);
        padding: 1.5rem;
        border-radius: 12px;
        max-width: 760px;
        width: 100%;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        color: #fff;
      }

      .row {
        display:flex;
        gap: 12px;
        align-items:center;
        flex-wrap:wrap;
      }

      label {
        display:block;
        margin-bottom: 6px;
        font-weight:600;
      }

      select, input[type="number"], button {
        font-family: Compass, inherit;
        padding: 0.5rem 0.75rem;
        font-size: 16px;
        border-radius: 8px;
        border: none;
        outline: none;
      }

      select, input[type="number"] {
        min-width: 220px;
      }

      .controls {
        margin-top: 8px;
        display:flex;
        gap: 10px;
        flex-wrap:wrap;
      }

      button#generateBtn {
        background: #4CAF50;
        color: white;
        cursor: pointer;
        font-weight:700;
      }
      button#generateBtn:active { transform: translateY(1px); }

      #response {
        margin-top: 12px;
        background: rgba(255,255,255,0.06);
        padding: 12px;
        border-radius: 8px;
        color: white;
        font-size: 16px;
        line-height: 1.4;
      }

      footer {
        background-color: var(--accent);
        color: white;
        text-align: center;
        padding: 0.75rem;
        position: relative;
        bottom: 0;
        width: 100%;
        font-size: 14px;
      }

      @media (max-width: 520px) {
        select, input[type="number"] { min-width: 100%; }
        .controls { flex-direction: column; }
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Ultra Drop Calculator</h1>
      <p style="margin:0;color:rgba(255,255,255,0.9)">Select dungeon & ultra → enter Luck → click Generate</p>
    </header>

    <main>
      <section class="panel" aria-labelledby="panelTitle">
        <h2 id="panelTitle" style="margin-top:0;color:#fff">Calculator</h2>

        <div class="row" style="margin-bottom:10px;">
          <div style="flex:1 1 260px;">
            <label for="dungeonSelect">Dungeon</label>
            <select id="dungeonSelect"><option>Loading…</option></select>
          </div>

          <div style="flex:1 1 260px;">
            <label for="ultraSelect">Ultra</label>
            <select id="ultraSelect"><option>Loading…</option></select>
          </div>
        </div>

        <div class="row controls">
          <div>
            <label for="luckInput">Luck (LCK) — 0 to 25</label>
            <input id="luckInput" type="number" min="0" max="25" value="0" />
          </div>

          <div style="align-self:flex-end;">
            <button id="generateBtn" type="button">Generate Ultra Data</button>
          </div>
        </div>

        <div id="response" aria-live="polite"></div>
      </section>
    </main>

    <footer>
      ℹ Licensed under CC0-1.0. Source: <a href="https://github.com/Aratox-Official/UltraCalculator" style="color:inherit;text-decoration:underline">GitHub</a>
    </footer>

    <script>
      function slugify(str = "") {
        return String(str)
          .toLowerCase()
          .trim()
          .replace(/\s+/g, "_")
          .replace(/[^a-z0-9_]/g, "");
      }

      let ultraData = [];
      let dungeonData = [];

      const dungeonSelect = document.getElementById("dungeonSelect");
      const ultraSelect = document.getElementById("ultraSelect");
      const luckInput = document.getElementById("luckInput");
      const generateBtn = document.getElementById("generateBtn");
      const responseEl = document.getElementById("response");

      async function loadAllData() {
        try {
          const [uRes, dRes] = await Promise.all([
            fetch("ultra_names.json"),
            fetch("dungeon_list.json")
          ]);

          if (!uRes.ok) throw new Error("Failed to load ultra_names.json");
          if (!dRes.ok) throw new Error("Failed to load dungeon_list.json");

          ultraData = await uRes.json();
          dungeonData = await dRes.json();

          populateDungeonSelect();
          populateUltraSelect();
        } catch (err) {
          dungeonSelect.innerHTML = '<option>Error loading data</option>';
          ultraSelect.innerHTML = '<option>Error loading data</option>';
          responseEl.textContent = "Error loading JSON files: " + err.message;
          console.error(err);
        }
      }

      function populateDungeonSelect() {
        dungeonData.sort((a, b) => {
          const aName = (a.name || a.id || "").toString();
          const bName = (b.name || b.id || "").toString();
          return aName.localeCompare(bName);
        });

        dungeonSelect.innerHTML = '<option value="">-- Select a dungeon --</option>';
        dungeonData.forEach(d => {
          const display = (d.name || d.id || "").toString().replace(/_/g, " ");
          const option = document.createElement("option");
          option.value = d.name || d.id || display;
          option.textContent = display;
          dungeonSelect.appendChild(option);
        });
      }

      function populateUltraSelect() {
        ultraData.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

        ultraSelect.innerHTML = '<option value="">-- Select an ultra --</option>';
        ultraData.forEach(u => {
          const option = document.createElement("option");
          option.textContent = u.name || ("#" + u.id);
          option.value = (typeof u.id !== "undefined") ? String(u.id) : u.name;
          ultraSelect.appendChild(option);
        });
      }

      generateBtn.addEventListener("click", () => {
        if (!ultraData.length || !dungeonData.length) {
          responseEl.textContent = "Data not loaded yet. Please wait a moment and try again.";
          return;
        }

        const dungeonValue = dungeonSelect.value;
        const ultraValue = ultraSelect.value;
        let luck = parseInt(luckInput.value, 10);
        if (Number.isNaN(luck)) luck = 0;
        luck = Math.max(0, Math.min(25, luck));
        luckInput.value = String(luck);

        if (!dungeonValue || !ultraValue) {
          responseEl.innerHTML = "<strong>Please select both a dungeon and an ultra, then click Generate.</strong>";
          return;
        }

        const dungeon = dungeonData.find(d => {
          if (!d) return false;
          const dName = (d.name || "").toString();
          const dId   = (typeof d.id !== "undefined") ? String(d.id) : "";
          return dName === dungeonValue || dId === dungeonValue;
        });

        const ultra = ultraData.find(u => {
          if (!u) return false;
          if (typeof u.id !== "undefined") {
            return String(u.id) === ultraValue;
          }
          return u.name === ultraValue;
        });

        if (!dungeon) {
          responseEl.innerHTML = `<strong>Selected dungeon not found in dungeon_list.json.</strong>`;
          return;
        }
        if (!ultra) {
          responseEl.innerHTML = `<strong>Selected ultra not found in ultra_names.json.</strong>`;
          return;
        }

        const ultraTickets = Number(ultra.tickets);
        const dungeonTickets = Number(dungeon.tickets);

        if (!isFinite(ultraTickets) || !isFinite(dungeonTickets) || dungeonTickets <= 0) {
          responseEl.innerHTML = `<strong>Tickets data missing or invalid for dungeon/ultra.</strong>`;
          return;
        }

        const dropChance = (100 * ultraTickets / dungeonTickets) * ((0.0005 * luck) + 0.006);

        const ultraDropsIn = (ultra.drops_in || "").toString();
        const dungeonSlug = slugify(dungeon.name || dungeon.id || "");
        const dropsMatch = (
          ultraDropsIn === "" ||
          ultraDropsIn === dungeonSlug ||
          ultraDropsIn === String(dungeon.id) ||
          slugify(ultraDropsIn) === dungeonSlug
        );

        const prettyDungeonName = (dungeon.name || dungeon.id || "").toString().replace(/_/g, " ");
        const prettyDropsIn = (ultra.drops_in || "").toString().replace(/_/g, " ");

        let html = `<strong>${ultra.name}</strong> — Tickets: <strong>${ultraTickets}</strong><br>`;
        html += `Dungeon: <strong>${prettyDungeonName}</strong> — Dungeon tickets: <strong>${dungeonTickets}</strong><br><br>`;
        html += `Luck (LCK): <strong>${luck}</strong><br>`;
        html += `<div style="margin-top:8px;font-size:1.15em">Calculated drop chance: <strong>${dropChance.toFixed(4)}%</strong></div>`;

        if (!dropsMatch) {
          html += `<div style="margin-top:10px;color:#ffeb99">Note: this ultra normally drops in <strong>${prettyDropsIn || "another dungeon"}</strong>. You selected <strong>${prettyDungeonName}</strong>. Calculation uses the selected dungeon's ticket total.</div>`;
        }

        responseEl.innerHTML = html;
      });

      loadAllData();
    </script>
  </body>
</html>
